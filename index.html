<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
      body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 20px; background-color: #f7f9fc; color: #333; }
      .container { max-width: 800px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
      h1, h2 { color: #1a237e; border-bottom: 2px solid #e8eaf6; padding-bottom: 10px; }
      #scoreboard { text-align: center; font-size: 3.5em; font-weight: bold; color: #0d47a1; margin-bottom: 20px; }
      .section { margin-bottom: 25px; padding: 15px; background: #f1f3f5; border-radius: 8px; }
      label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
      select, button, input { width: 100%; padding: 12px; font-size: 1em; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; margin-bottom: 10px;}
      button { cursor: pointer; font-weight: bold; color: white; border: none; transition: background-color 0.2s; }
      button:active { transform: scale(0.98); }
      .actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
      .btn-create { background-color: #1976d2; }
      .btn-made { background-color: #2e7d32; }
      .btn-missed { background-color: #d32f2f; }
      table { width: 100%; border-collapse: collapse; margin-top: 20px; }
      th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
      th { background-color: #3949ab; color: white; }
      tbody tr:nth-child(even) { background-color: #f2f2f2; }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>バスケ スコアブック</h1>

      <div class="section">
        <h2>試合の管理</h2>
        <label for="game-select">試合を選択</label>
        <select id="game-select" onchange="loadSelectedGame()"><option value="">-- 試合を選択 --</option></select>
        <hr style="margin: 20px 0;">
        <label for="new-game-name">新しい試合を作成</label>
        <input type="text" id="new-game-name" placeholder="例：練習試合 vs. ABC高校">
        <button onclick="createGame()" class="btn-create">試合を作成</button>
      </div>

      <h2 id="current-game-title">試合を選択してください</h2>
      <div id="scoreboard">0</div>

      <div class="section" id="recorder-section" style="display:none;">
        <h2>記録</h2>
        <label for="player-select">選手を選択</label>
        <select id="player-select"></select>
        <div class="actions">
          <button onclick="record('2P成功')" class="btn-made">2P成功</button>
          <button onclick="record('2P失敗')" class="btn-missed">2P失敗</button>
          <button onclick="record('3P成功')" class="btn-made">3P成功</button>
          <button onclick="record('3P失敗')" class="btn-missed">3P失敗</button>
          <button onclick="record('FT成功')" class="btn-made">FT成功</button>
          <button onclick="record('FT失敗')" class="btn-missed">FT失敗</button>
        </div>
      </div>

      <h2>個人スタッツ</h2>
      <div id="stats-table"><p>試合を選択すると、ここにスタッツが表示されます。</p></div>
    </div>

    <script>
      let currentGameId = null;
      let localStats = {}; // ★★★ ローカルにスタッツを保持するオブジェクト ★★★
      let headers = ['選手名', 'PTS', 'FGM', 'FGA', '3PM', '3PA', 'FTM', 'FTA'];

      document.addEventListener('DOMContentLoaded', () => {
        loadPlayers();
        loadGames();
      });

      // --- 試合管理 ---
      function createGame() {
        const gameNameInput = document.getElementById('new-game-name');
        const gameName = gameNameInput.value.trim();
        if (!gameName) return alert('試合名を入力してください。');
        
        google.script.run.withSuccessHandler(response => {
          if (response.status !== 'success') return alert('エラー: ' + response.message);
          const { newGame } = response;
          const select = document.getElementById('game-select');
          const option = new Option(newGame.name, newGame.id);
          select.add(option);
          select.value = newGame.id;
          gameNameInput.value = '';
          loadSelectedGame();
        }).createNewGame(gameName);
      }

      function loadGames() {
        google.script.run.withSuccessHandler(games => {
          const select = document.getElementById('game-select');
          while (select.options.length > 1) select.remove(1);
          games.forEach(game => select.add(new Option(game.name, game.id)));
        }).getGames();
      }
      
      function loadSelectedGame() {
        const select = document.getElementById('game-select');
        currentGameId = select.value;
        const gameName = select.options[select.selectedIndex].text;
        const recorderSection = document.getElementById('recorder-section');
        
        if (currentGameId) {
          document.getElementById('current-game-title').textContent = gameName;
          recorderSection.style.display = 'block';
          google.script.run.withSuccessHandler(data => {
            // サーバーから取得した初期データをローカルに保存
            localStats = {};
            data.stats.forEach(row => {
              const [player, PTS, FGM, FGA, P3M, P3A, FTM, FTA] = row;
              localStats[player] = { PTS, FGM, FGA, '3PM': P3M, '3PA': P3A, FTM, FTA };
            });
            updateDisplay();
          }).getStatsAndScore(currentGameId);
        } else {
          document.getElementById('current-game-title').textContent = '試合を選択してください';
          recorderSection.style.display = 'none';
          localStats = {};
          updateDisplay();
        }
      }

      // --- 選手と記録 ---
      function loadPlayers() {
        google.script.run.withSuccessHandler(players => {
          const select = document.getElementById('player-select');
          select.innerHTML = '';
          players.forEach(player => select.add(new Option(player, player)));
        }).getPlayers();
      }

      // ★★★ ここからが高速化の核心部 ★★★
      function record(play) {
        const player = document.getElementById('player-select').value;
        if (!player || !currentGameId) return;

        // Step 1: ローカルのスタッツを即座に更新
        if (!localStats[player]) {
          localStats[player] = { PTS: 0, FGM: 0, FGA: 0, '3PM': 0, '3PA': 0, FTM: 0, FTA: 0 };
        }
        const stats = localStats[player];
        switch (play) {
          case '2P成功': stats.PTS += 2; stats.FGM++; stats.FGA++; break;
          case '2P失敗': stats.FGA++; break;
          case '3P成功': stats.PTS += 3; stats.FGM++; stats.FGA++; stats['3PM']++; stats['3PA']++; break;
          case '3P失敗': stats.FGA++; stats['3PA']++; break;
          case 'FT成功': stats.PTS += 1; stats.FTM++; stats.FTA++; break;
          case 'FT失敗': stats.FTA++; break;
        }

        // Step 2: 更新されたローカルスタッツを元に画面を再描画（即時反映）
        updateDisplay();

        // Step 3: バックグラウンドでサーバーにデータを送信（ユーザーは待たない）
        google.script.run.recordPlayInBackground(player, play, currentGameId);
      }

      // --- 表示更新 ---
      function updateDisplay() {
        let totalScore = 0;
        const statsArray = [];

        // ヘッダー順にソートして表示を安定させる
        const sortedPlayers = Object.keys(localStats).sort();

        for(const player of sortedPlayers) {
            const p = localStats[player];
            totalScore += p.PTS;
            statsArray.push([player, p.PTS, p.FGM, p.FGA, p['3PM'], p['3PA'], p.FTM, p.FTA]);
        }

        document.getElementById('scoreboard').textContent = totalScore;

        const tableDiv = document.getElementById('stats-table');
        if (statsArray.length === 0) {
          tableDiv.innerHTML = '<p>この試合の記録はまだありません。</p>';
          return;
        }

        let tableHTML = '<table><thead><tr>';
        headers.forEach(header => { tableHTML += `<th>${header}</th>`; });
        tableHTML += '</tr></thead><tbody>';
        statsArray.forEach(row => {
          tableHTML += '<tr>';
          row.forEach(cell => { tableHTML += `<td>${cell}</td>`; });
          tableHTML += '</tr>';
        });
        tableHTML += '</tbody></table>';
        tableDiv.innerHTML = tableHTML;
      }
    </script>
  </body>
</html>
